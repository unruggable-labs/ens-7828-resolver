# ENS-7828-Resolver Architecture

## Overview

This document describes the chain mapping and resolution system in the ENS-7828-Resolver library, focusing on how the chain mapping is generated, maintained, and used for multi-chain ENS name resolution.

---

## Chain Mapping Generation

### Data Sources

- **EVM Chains:**
  - Pulled from the [ethereum-lists/chains](https://github.com/ethereum-lists/chains) repository (JSON files for each chain)
  - Includes chainId, shortName, name, coinType (uint), and other metadata
  - **Coin type is derived using [ENSIP-11](https://docs.ens.domains/ensip/11):** `(chainId | 0x80000000) >>> 0` (i.e., 0x80000000 + chainId)
- **Non-EVM Chains:**
  - Manually curated in `scripts/chains.ts` as `MANUAL_CHAINS`
  - Includes Solana, Bitcoin, and other popular non-EVM chains
  - **Coin type is the [SLIP-44](https://github.com/satoshilabs/slips/blob/master/slip-0044.md) value for the chain (no offset)**

### Build Script

- The mapping is generated by running:
  ```bash
  npm run prepare
  ```
- This script:
  1. Fetches EVM chain data from ethereum-lists
  2. Merges with manually curated non-EVM chains
  3. Ensures each chain has a valid slip44 (coin type):
     - Uses the value from the data source if available
     - Otherwise, derives it using [ENSIP-11](https://docs.ens.domains/ensip/11/): `(chainId | 0x80000000) >>> 0`
  4. Outputs a single TypeScript file: `src/chain-mapping.ts`

### ChainInfo Structure

Each chain is represented as a `ChainInfo` object:

```typescript
interface ChainInfo {
  chainId: number | string;
  shortName: string;
  name: string;
  coinType: number; // For EVM: ENSIP-11, for non-EVM: SLIP-44 value
  namespace: string;
  reference: string;
}
```

### Mapping Outputs

- `chains`: Array of all supported chains
- `byChainId`: Map from chainId to ChainInfo
- `byShortName`: Map from shortName to ChainInfo
- `byNameSpaceReference`: Map from CAIP-2 reference to ChainInfo
- `MANUAL_CHAINS`: Map of manually curated non-EVM chains

---

## Resolution Flow

1. **Parsing:**
   - The input (e.g., `alice.eth@base`) is parsed to extract the ENS name and chain spec
2. **Chain Resolution:**
   - The chain spec is resolved using the generated mapping (by chainId, shortName, or CAIP-2 reference)
   - If not found, an error is thrown
3. **Address Resolution:**
   - For EVM chains, uses the ENS resolver contract (single or multi-coin ABI)
   - For non-EVM chains, decodes the address using the appropriate encoding (e.g., base58 for Solana, bech32/base58 for Bitcoin)

---

## Standards & References

- [EIP-7828](https://github.com/jrudolf/ERCs/blob/master/ERCS/erc-7828.md): Human-Readable Chain-Specific ENS Names
- [EIP-7785](https://eips.ethereum.org/EIPS/eip-7785): ENS Chain Specification (future)
- [ENSIP-9](https://eips.ethereum.org/EIPS/eip-2055): Multi-Coin Support
- [SLIP-44](https://github.com/satoshilabs/slips/blob/master/slip-0044.md): Coin Types
- [CAIP-2](https://github.com/ChainAgnostic/CAIPs/blob/master/CAIPs/caip-2.md): Chain Identifiers
- [CAIP-10](https://github.com/ChainAgnostic/CAIPs/blob/master/CAIPs/caip-10.md): Account Identifiers

---

## Future Standards: ERC-7930, ERC-7785, and Chain Metadata

The long-term vision for multi-chain ENS resolution is to wire together these standards:

1. **ERC-7930**: Returns a 64-byte address blob: `[20-byte account][12-byte zero padding][32-byte namespaceId]`, where `namespaceId` is the ENS namehash of the chain domain (e.g., `base.l2.eth`).
2. The last 32 bytes (`namespaceId`) are used as the key into the ENS registry:
   ```js
   const nsBytes = blob.slice(32, 64); // bytes 32â€“63
   resolverAddress = ENS_REGISTRY.resolver(nsBytes);
   ```
3. The resolver contract is expected to implement **ERC-7785**'s `IChainInfoResolver` interface, so you can query chain metadata:
   ```solidity
   chainId     = resolver.chainId(nsBytes);
   rpcURLs     = resolver.getRPCURLs(nsBytes);
   trustModel  = resolver.getTrustModel(nsBytes);
   finality    = resolver.getFinalityInfo(nsBytes);
   ```
   This provides all the metadata needed to interact with the chain.

**Current State:**

- As of now, live ERC-7785 resolvers are not yet deployed. Until then, clients fall back to CAIP-2 or a JSON chain list for chain mapping and metadata.

---

## Updating the Mapping

- To add or update a chain:
  1. Edit `scripts/chains.ts` (for new EVM or non-EVM chains)
  2. Run `npm run prepare` to regenerate the mapping
  3. Commit the updated `src/chain-mapping.ts`

---

## Contact

For questions or contributions, see the main [README](./README.md) or open an issue on GitHub.
